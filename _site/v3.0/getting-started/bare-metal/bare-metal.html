<!-- Set this_pages_navbar  -->












<!Doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link rel="stylesheet" href='https://fonts.googleapis.com/css?family=Roboto+Mono' type='text/css'>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/plugins/offcanvas.css"/>
    <link href="https://www.projectcalico.org/wp-content/themes/dante/css/font-awesome.min.css" rel="stylesheet">
    <script src="/js/jquery-2.2.0.min.js"></script>
    <script src="/js/bootstrap/bootstrap.min.js"></script>
    <script src="/js/script.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52125893-4', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Using Calico to Secure Host Interfaces</title>
<meta name="generator" content="Jekyll v3.7.2" />
<meta property="og:title" content="Using Calico to Secure Host Interfaces" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://docs.projectcalico.org/v3.0/getting-started/bare-metal/bare-metal" />
<meta property="og:url" content="https://docs.projectcalico.org/v3.0/getting-started/bare-metal/bare-metal" />
<script type="application/ld+json">
{"headline":"Using Calico to Secure Host Interfaces","@type":"WebPage","url":"https://docs.projectcalico.org/v3.0/getting-started/bare-metal/bare-metal","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <section>
      <nav id="toplevel-nav" class="navbar navbar-default navbar-static-top">
        <div class="container">
          <div class="navbar-header">
            <!-- Hamburger menu for mobile -->
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#tigera-navbar" aria-expanded="false" aria-controls="tigera-navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <!-- Left brand image -->
            <a class="navbar-brand" href="https://projectcalico.org/">
              <img alt="Brand" src="/images/brand.png">
            </a>
          </div>
          <div id="tigera-navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://projectcalico.org">Home</a></li>
              <li class="active"><a href="https://projectcalico.org/resources"><span>Resources</span></a>
                <ul>
                    <li><a href="/latest/getting-started/"><i class="fa fa-tachometer" aria-hidden="true"></i> &nbsp; Getting Started</a></li>
                    <li><a href=""><i class="fa fa-book" aria-hidden="true"></i> &nbsp; Documentation</a></li>
                    <!--<li><a href="https://www.projectcalico.org/tutorials"><i class="fa fa-file-code-o" aria-hidden="true"></i> &nbsp; Tutorials &amp; Examples</a></li>
                    <li><a href=""><i class="fa fa-paper-plane-o" aria-hidden="true"></i> &nbsp; Online Workshops</a></li>-->
                    <li><a href="https://www.projectcalico.org/videos"><i class="fa fa-video-camera" aria-hidden="true"></i> &nbsp; Videos &amp; Webinars</a></li>
                    <li><a href="https://www.projectcalico.org/training"><i class="fa fa-graduation-cap" aria-hidden="true"></i> &nbsp; Training</a></li>
                    <li><a href="/latest/releases/"><i class="fa fa-clock-o" aria-hidden="true"></i> &nbsp; Releases</a></li>
                    <!-- <li><a href="/mvp"><i class="fa fa-star" aria-hidden="true"></i> &nbsp; MVP Program</a></li> -->
                    <li><a href="https://www.projectcalico.org/blog"><i class="fa fa-bookmark" aria-hidden="true"></i> &nbsp; Blog</a></li>
                </ul>
              </li>
              <li><a href="https://www.projectcalico.org/community">Community</a>
                <ul>
                    <li><a href="https://slack.projectcalico.org/"><i class="fa fa-slack" aria-hidden="true"></i> &nbsp; Slack</a></li>
                    <!--<li><a href="https://stackoverflow.com/questions/tagged/project-calico" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i> &nbsp; StackOverflow</a></li>-->
                    <li><a href="https://www.projectcalico.org/mvp"><i class="fa fa-star" aria-hidden="true"></i> &nbsp; MVP Program</a></li>
                    <li><a href="https://www.projectcalico.org/community#events"><i class="fa fa-calendar" aria-hidden="true"></i> &nbsp; Upcoming Events</a></li>
                    <li><a href="https://www.projectcalico.org/newsletters"><i class="fa fa-envelope-o" aria-hidden="true"></i> &nbsp; Newsletter</a></li>
                    <li><a href="https://github.com/projectcalico" target="_blank"><i class="fa fa-github" aria-hidden="true"></i> &nbsp; GitHub</a></li> 
                    <li><a href="https://www.projectcalico.org/jobs"><i class="fa fa-briefcase" aria-hidden="true"></i> &nbsp; Jobs</a></li>
                    <li><a href="https://www.projectcalico.org/blog"><i class="fa fa-bookmark" aria-hidden="true"></i> &nbsp; Blog</a></li>
                </ul>
              </li>
              <li><a href="https://www.projectcalico.org/mvp" style="font-weight: bold;">MVP</a></li>
              <li><a href="https://www.projectcalico.org/support">Support</a></li>
              <li class="hidden-xs"><a href="https://www.projectcalico.org/support">
                <img class="desktopImage" width="30" align="absmiddle" src="https://www.projectcalico.org/images/tigera_trans_sm.png" alt="Tigera"></a>
              </li>
            </ul>
            <form class="navbar-form visible-xs">
              <ul class="nav navbar-nav navbar-right">
                
                  <li >
                    <a href="/v3.0/introduction">Introduction</a>
                  </li>
                
                  <li  class="active">
                    <a href="/v3.0/getting-started">Getting Started</a>
                  </li>
                
                  <li >
                    <a href="/v3.0/usage">Usage</a>
                  </li>
                
                  <li >
                    <a href="/v3.0/reference">Reference</a>
                  </li>
                
                  <li >
                    <a href="/v3.0/releases">Releases</a>
                  </li>
                
              </ul>
            </form>
            <ul class="visible-xs nav navbar-nav navbar-right">
             <li class="dropdown">
               <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Version (v3.0)<span class="caret"></span></a>
               <ul class="dropdown-menu">
                 <li><a href="/v2.6/introduction">v2.6 (latest)</a></li>
                 <li><a href="/v2.5/introduction">v2.5</a></li>
                 <li><a href="/v2.4/introduction">v2.4</a></li>
                 <li><a href="/v2.3/introduction">v2.3</a></li>
                 <li><a href="/v2.2/introduction">v2.2</a></li>
                 <li><a href="/v2.1/introduction">v2.1</a></li>
                 <li><a href="/v2.0/introduction">v2.0</a></li>
                 <li><a href="/v1.6/introduction">v1.6</a></li>
                 <li><a href="/v1.5/introduction">v1.5</a></li>
                 <li><a href="/v3.0/introduction">v3.0 (beta)</a></li>
                 <li><a href="/master/introduction">nightly</a></li>
                 <li role="separator" class="divider"></li>
               </ul>
             </li>
           </ul>
          </div>
        </div>
        <div id="navbar" class="navbar-inverse navbar-collapse collapse">
          <div class="container">
            <ul class="nav navbar-nav">
              
                <li>
                  <a href="/v3.0/introduction"><span>Introduction</span></a>
                </li>
              
                <li class="active">
                  <a href="/v3.0/getting-started"><span>Getting Started</span></a>
                </li>
              
                <li>
                  <a href="/v3.0/usage"><span>Usage</span></a>
                </li>
              
                <li>
                  <a href="/v3.0/reference"><span>Reference</span></a>
                </li>
              
                <li>
                  <a href="/v3.0/releases"><span>Releases</span></a>
                </li>
              
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Version (v3.0)<span class="caret"></span></a>
                <ul class="dropdown-menu">
                   <li><a href="/v3.0/introduction">v3.0 (latest)</a></li>
                   <li><a href="/v2.6/introduction">v2.6</a></li>
                   <li><a href="/v2.5/introduction">v2.5</a></li>
                   <li><a href="/v2.4/introduction">v2.4</a></li>
                   <li><a href="/v2.3/introduction">v2.3</a></li>
                   <li><a href="/v2.2/introduction">v2.2</a></li>
                   <li><a href="/v2.1/introduction">v2.1</a></li>
                   <li><a href="/v2.0/introduction">v2.0</a></li>
                   <li><a href="/v1.6/introduction">v1.6</a></li>
                   <li><a href="/v1.5/introduction">v1.5</a></li>
                  <li role="separator" class="divider"></li>
                  <li><a href="/master/introduction">nightly</a></li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="row">
            <div class="col-sm-0"></div>
          </div>
        </div>
      </nav>
      <div class="container">
        <div class="row row-offcanvas row-offcanvas-left">
          <p class="pull-left visible-xs">
            <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button>
          </p>
          <div class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
            <div class="row">
              <script>
                (function() {
                  var cx = '015028447179048192876:xjzskk7awwe';
                  var gcse = document.createElement('script');
                  gcse.type = 'text/javascript';
                  gcse.async = true;
                  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                  var s = document.getElementsByTagName('script')[0];
                  s.parentNode.insertBefore(gcse, s);
                })();
              </script>
              <gcse:search></gcse:search>
            </div>
            <div id="sidebar">
            	

  
    
    
    <div class="link">
      <a class="item" data-title="Getting Started with Calico" href="/v3.0/getting-started/">
        Getting Started with Calico
      </a>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-kubernetes" aria-expanded="false" aria-controls="nav-kubernetes">
          Kubernetes
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-kubernetes">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Quickstart" href="/v3.0/getting-started/kubernetes/">
        Quickstart
      </a>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-kubernetes-installation" aria-expanded="false" aria-controls="nav-kubernetes-installation">
          Installation
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-kubernetes-installation">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Introduction" href="/v3.0/getting-started/kubernetes/installation/">
        Introduction
      </a>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-kubernetes-installation-hosted-viakubectl" aria-expanded="false" aria-controls="nav-kubernetes-installation-hosted-viakubectl">
          Hosted (via kubectl)
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-kubernetes-installation-hosted-viakubectl">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Introduction" href="/v3.0/getting-started/kubernetes/installation/hosted/">
        Introduction
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Standard Hosted Install" href="/v3.0/getting-started/kubernetes/installation/hosted/hosted">
        Standard Hosted Install
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Kubeadm Hosted Install" href="/v3.0/getting-started/kubernetes/installation/hosted/kubeadm/">
        Kubeadm Hosted Install
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Kubernetes Datastore Hosted Install" href="/v3.0/getting-started/kubernetes/installation/hosted/kubernetes-datastore/">
        Kubernetes Datastore Hosted Install
      </a>
    </div>
  


        </div>
      </div>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Integration Guide" href="/v3.0/getting-started/kubernetes/installation/integration">
        Integration Guide
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="AWS" href="/v3.0/getting-started/kubernetes/installation/aws">
        AWS
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="GCE" href="/v3.0/getting-started/kubernetes/installation/gce">
        GCE
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Azure" href="/v3.0/getting-started/kubernetes/installation/azure">
        Azure
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Vagrant/VirtualBox: CoreOS" href="/v3.0/getting-started/kubernetes/installation/vagrant/">
        Vagrant/VirtualBox: CoreOS
      </a>
    </div>
  


        </div>
      </div>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-kubernetes-tutorials" aria-expanded="false" aria-controls="nav-kubernetes-tutorials">
          Tutorials
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-kubernetes-tutorials">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Using calicoctl" href="/v3.0/getting-started/kubernetes/tutorials/using-calicoctl">
        Using calicoctl
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Simple Policy Demo" href="/v3.0/getting-started/kubernetes/tutorials/simple-policy">
        Simple Policy Demo
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Stars Policy Demo" href="/v3.0/getting-started/kubernetes/tutorials/stars-policy/">
        Stars Policy Demo
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Advanced network policy" href="/v3.0/getting-started/kubernetes/tutorials/advanced-policy">
        Advanced network policy
      </a>
    </div>
  


        </div>
      </div>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Troubleshooting / FAQ" href="/v3.0/getting-started/kubernetes/troubleshooting">
        Troubleshooting / FAQ
      </a>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-kubernetes-upgrade" aria-expanded="false" aria-controls="nav-kubernetes-upgrade">
          Upgrade
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-kubernetes-upgrade">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Overview" href="/v3.0/getting-started/kubernetes/upgrade/">
        Overview
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Install and configure calico-upgrade" href="/v3.0/getting-started/kubernetes/upgrade/setup">
        Install and configure calico-upgrade
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Test the migration" href="/v3.0/getting-started/kubernetes/upgrade/test">
        Test the migration
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Migrate your data" href="/v3.0/getting-started/kubernetes/upgrade/migrate">
        Migrate your data
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Upgrade Calico" href="/v3.0/getting-started/kubernetes/upgrade/upgrade">
        Upgrade Calico
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Converting your calicoctl manifests" href="/v3.0/getting-started/kubernetes/upgrade/convert">
        Converting your calicoctl manifests
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Deleting old data" href="/v3.0/getting-started/kubernetes/upgrade/delete">
        Deleting old data
      </a>
    </div>
  

  
    
    
    <div class="link">
      <a class="item" data-title="Downgrading Calico" href="/v3.0/getting-started/kubernetes/upgrade/downgrade">
        Downgrading Calico
      </a>
    </div>
  


        </div>
      </div>
    </div>
  


        </div>
      </div>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-openshift" aria-expanded="false" aria-controls="nav-openshift">
          OpenShift
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-openshift">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Installation" href="/v3.0/getting-started/openshift/installation">
        Installation
      </a>
    </div>
  


        </div>
      </div>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-hostprotection" aria-expanded="false" aria-controls="nav-hostprotection">
          Host Protection
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-hostprotection">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Overview" href="/v3.0/getting-started/bare-metal/bare-metal">
        Overview
      </a>
    </div>
  

  
    
    <div>
      <div class="link">
        <span class="glyphicon glyphicon-chevron-right navbar-arrow"></span>
        <a role="button" data-toggle="collapse" href="#nav-hostprotection-installation" aria-expanded="false" aria-controls="nav-hostprotection-installation">
          Installation
        </a>
      </div>
      <div class="section">
        <div class="collapse" id="nav-hostprotection-installation">
          

  
    
    
    <div class="link">
      <a class="item" data-title="Installing Felix as a static binary" href="/v3.0/getting-started/bare-metal/bare-metal-install">
        Installing Felix as a static binary
      </a>
    </div>
  


        </div>
      </div>
    </div>
  


        </div>
      </div>
    </div>
  


			</div>
          </div>
          <div class="col-xs-12 col-sm-8 col-md-9">
            <div id="content-main">
              <!-- TOP DOCUMENTATION PAGE NAVBAR -->
              <div style="text-align: left; padding: 18px 0 9px 0; min-width: 500px; overflow-x: hidden;">
              
              <a data-proofer-ignore href="https://github.com/projectcalico/calico/tree/master/v3.0/getting-started/bare-metal/bare-metal.md" style="color: #999; text-decoration: none; float: right;" target="_blank"><i class="fa fa-github" aria-hidden="true"></i> Edit this page</a></div>
              <!-- END TOP DOCUMENTATION PAGE NAVBAR -->
              

              <h1>Using Calico to Secure Host Interfaces</h1>
              <p>This guide describes how to use Calico to secure the network interfaces
of the host itself (as opposed to those of any container/VM workloads
that are present on the host). We call such interfaces “host endpoints”,
to distinguish them from “workload endpoints” (such as containers or VMs).</p>

<p>Calico supports the same rich security policy model for host endpoints (host 
endpoint policy) that it supports for workload endpoints. Host endpoints can 
have labels, and their labels are in the same “namespace” as those of workload 
endpoints. This allows security rules for either type of endpoint to refer to 
the other type (or a mix of the two) using labels and selectors.</p>

<p>Calico does not support setting IPs or policing MAC addresses for host
interfaces, it assumes that the interfaces are configured by the
underlying network fabric.</p>

<p>Calico distinguishes workload endpoints from host endpoints by a configurable
prefix.  Unless you happen to have host interfaces whose name matches the
default for that prefix (<code class="highlighter-rouge">cali</code>), you won’t need to change it.  In case you do,
see the <code class="highlighter-rouge">InterfacePrefix</code> configuration value at <a href="/v3.0/reference/felix/configuration">Configuring
Felix</a>.
Interfaces that start with a value listed in <code class="highlighter-rouge">InterfacePrefix</code> are assumed to
be workload interfaces.  Others are treated as host interfaces.</p>

<p>Calico blocks all traffic to/from workload interfaces by default;
allowing traffic only if the interface is known and policy is in place.
However, for host endpoints, Calico is more lenient; it only polices
traffic to/from interfaces that it’s been explicitly told about. Traffic
to/from other interfaces is left alone.</p>

<p>You can use host endpoint policy to secure a NAT gateway or router. Calico
supports selector-based policy when running on a gateway or router, allowing for
rich, dynamic security policy based on the labels attached to your host endpoints.</p>

<p>You can apply host endpoint policies to three types of traffic:</p>
<ul>
  <li>Traffic that is terminated locally.</li>
  <li>Traffic that is forwarded between host endpoints.</li>
  <li>Traffic that is forwarded between a host endpoint and a workload endpoint on the 
same host.</li>
</ul>

<p>Set the <code class="highlighter-rouge">applyOnForward</code> flag to <code class="highlighter-rouge">true</code> to apply a policy to forwarded traffic.
See <a href="/v3.0/reference/calicoctl/resources/globalnetworkpolicy#spec">GlobalNetworkPolicy spec</a>.</p>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: Both traffic forwarded between host endpoints and traffic forwarded 
between a host endpoint and a workload endpoint on the same host is regarded as
<code class="highlighter-rouge">forwarded traffic</code>.</p>

  <p><img src="/images/bare-metal-packet-flows-AOF.png" alt="" /></p>
</blockquote>

<h2 id="installation-overview">Installation overview</h2>

<p>To make use of Calico’s host endpoint support, you will need to complete
the following steps.</p>

<ol>
  <li><a href="#creating-an-etcd-cluster">Create an etcd cluster, if you haven’t already</a>.</li>
  <li><a href="#install-and-configure-calicoctl">Install and configure <code class="highlighter-rouge">calicoctl</code></a>.</li>
  <li><a href="#installing-felix">Install the Felix daemon on each host</a>.</li>
  <li><a href="#initializing-the-etcd-database">Initialize the etcd database</a>.</li>
  <li><a href="#creating-basic-connectivity-and-policy">Add policy to allow basic connectivity</a>.</li>
  <li><a href="#creating-host-endpoint-objects">Create host endpoint objects in etcd</a> for each interface you want
Calico to police. (In a later 
release, we plan to support interface templates to remove the need to explicitly 
configure every interface).</li>
  <li><a href="#creating-more-security-policy">Insert policy into etcd</a> for Calico to apply.</li>
  <li><a href="#failsafe-rules">Decide whether to disable “failsafe SSH/etcd” access</a>.</li>
</ol>

<h2 id="creating-an-etcd-cluster">Creating an etcd cluster</h2>

<p>If you haven’t already created an etcd cluster for your Calico
deployment, you’ll need to create one.</p>

<p>To create a single-node etcd cluster for testing, download an etcd v3.x
release from <a href="https://github.com/coreos/etcd/releases">the etcd releases archive</a>; we recommend using
the most recent bugfix release. Then follow the instructions on that
page to unpack and run the etcd binary.</p>

<p>To create a production cluster, you should follow the guidance in the
<a href="https://coreos.com/etcd/docs/latest/">etcd manual</a>. In particular, the
<a href="https://coreos.com/etcd/docs/latest/">clustering guide</a>.</p>

<h3 id="install-and-configure-calicoctl">Install and configure calicoctl</h3>

<ol>
  <li>
    <p><a href="/v3.0/usage/calicoctl/install#installing-calicoctl-as-a-binary">Install calicoctl as a binary</a>.</p>
  </li>
  <li>
    <p><a href="/v3.0/usage/calicoctl/configure/">Configure calicoctl to connect to etcd</a>.</p>
  </li>
  <li>
    <p>Return to this page and continue to the <a href="#installing-felix">next section</a>.</p>
  </li>
</ol>

<h2 id="installing-felix">Installing Felix</h2>

<p>There are several ways to install Felix.</p>

<ul>
  <li>
    <p>If you are running Ubuntu 14.04 or 16.04, you can install from our PPA:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo add-apt-repository ppa:project-calico/calico-3.0
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install calico-felix
</code></pre></div>    </div>
  </li>
  <li>
    <p>If you are running a RedHat 7-derived distribution, you can install
from our RPM repository:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /etc/yum.repos.d/calico.repo &lt;&lt;EOF
[calico]
name=Calico Repository
baseurl=http://binaries.projectcalico.org/rpm/calico-3.0/
enabled=1
skip_if_unavailable=0
gpgcheck=1
gpgkey=http://binaries.projectcalico.org/rpm/calico-3.0/key
priority=97
EOF

yum install calico-felix
</code></pre></div>    </div>
  </li>
  <li>
    <p>If you are running another distribution, follow the instructions in
<a href="bare-metal-install">this document</a> to use the <code class="highlighter-rouge">calico-felix</code> binary
directly.</p>
  </li>
  <li>
    <p>If you want to run under Docker, you can use <code class="highlighter-rouge">calicoctl node run --node-image=quay.io/calico/node:v3.0.2</code> to start
the <code class="highlighter-rouge">calico/node</code> container image.  This container packages up the core Calico
components to provide both Calico networking and network policy.  Running
the container automatically pre-initializes the etcd database (which the
other installations methods do not).  See the
<a href="/v3.0/reference/calicoctl/commands/node/run"><code class="highlighter-rouge">calicoctl node run</code></a>
guide for details.</p>
  </li>
</ul>

<p>Until you initialize the database, Felix will make a regular log that it
is in state “wait-for-ready”. The default location for the log file is
<code class="highlighter-rouge">/var/log/calico/felix.log</code>.</p>

<h2 id="initializing-the-etcd-database">Initializing the etcd database</h2>

<p>If you are using the container-based installation (using the <code class="highlighter-rouge">calico/node</code>
container image), the database is initialized as soon as you start the first
node instance.</p>

<p>If you are self-installed you should configure a <code class="highlighter-rouge">node</code> resource for each
host running Felix.  In this case, the database is initialized after
creating the first <code class="highlighter-rouge">node</code> resource.  For a deployment that does not include
the Calico/BGP integration, the specification of a node resource just requires
the name of the node;  for most deployments this will be the same as the
hostname.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | calicoctl create -f -
- apiVersion: projectcalico.org/v3
  kind: Node
  metadata:
    name: &lt;node name or hostname&gt;
EOF
</code></pre></div></div>

<p>If you check the Felix logfile after this step, the logs should
transition from periodic notifications that Felix is in state
“wait-for-ready” to a stream of initialization messages.</p>

<h2 id="creating-basic-connectivity-and-policy">Creating basic connectivity and policy</h2>

<p>When a host endpoint is added, if there is no security policy for that
endpoint, Calico will default to denying traffic to/from that endpoint,
except for traffic that is allowed by the <a href="#failsafe-rules">failsafe rules</a>.</p>

<p>While the <a href="#failsafe-rules">failsafe rules</a> provide protection against removing all
connectivity to a host:</p>

<ul>
  <li>
    <p>They are overly broad in allowing inbound SSH on any interface and
allowing traffic out to etcd’s ports on any interface.</p>
  </li>
  <li>
    <p>Depending on your network, they may not cover all the ports that are
required; for example, your network may rely on allowing ICMP,
or DHCP.</p>
  </li>
</ul>

<p>Therefore, we recommend creating a failsafe Calico security policy that
is tailored to your environment. The example command below shows one
example of how you might do that; the command uses <code class="highlighter-rouge">calicoctl</code> to create a single 
policy resource, which:</p>

<ul>
  <li>Applies to all known endpoints.</li>
  <li>Allows inbound ssh access from a defined “management” subnet.</li>
  <li>Allows outbound connectivity to etcd on a particular IP; if
you have multiple etcd servers you should duplicate the rule
for each destination.</li>
  <li>Allows inbound ICMP.</li>
  <li>Allows outbound UDP on port 67, for DHCP.</li>
</ul>

<p>When running this command, replace the placeholders in angle brackets with
appropriate values for your deployment.
<!-- --></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | calicoctl create -f -
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: failsafe
  spec:
    selector: "all()"
    order: 0
    ingress:
    - action: Allow
      protocol: TCP
      source:
        nets:
        - "&lt;your management CIDR&gt;"
      destination:
        ports: [22]
    - action: Allow
      protocol: ICMP
    egress:
    - action: Allow
      protocol: TCP
      destination:
        nets:
        - "&lt;your etcd IP&gt;/32"
        ports: [&lt;your etcd ports&gt;]
    - action: Allow
      protocol: UDP
      destination:
        ports: [67]
EOF
</code></pre></div></div>

<p>Once you have such a policy in place, you may want to disable the
<a href="#failsafe-rules">failsafe rules</a>.</p>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: Packets that reach the end of the list of rules fall-through to the 
next policy (sorted by the <code class="highlighter-rouge">order</code> field).</p>

  <p>The selector in the policy, <code class="highlighter-rouge">all()</code>, will match <em>all</em> endpoints,
including any workload endpoints. If you have workload endpoints as
well as host endpoints then you may wish to use a more restrictive
selector. For example, you could label management interfaces with
label <code class="highlighter-rouge">endpoint_type = management</code> and then use selector
<code class="highlighter-rouge">endpoint_type == "management"</code></p>

  <p>If you are using Calico for networking workloads, you should add
inbound and outbound rules to allow BGP:  add an ingress and egress rule
to allow TCP traffic to destination port 179.</p>
</blockquote>

<h2 id="creating-host-endpoint-objects">Creating host endpoint objects</h2>

<p>For each host endpoint that you want Calico to secure, you’ll need to
create a host endpoint object in etcd.  Use the <code class="highlighter-rouge">calicoctl create</code> command
to create a host endpoint resource (<code class="highlighter-rouge">HostEndpoint</code>).</p>

<p>There are two ways to specify the interface that a host endpoint should
refer to. You can either specify the name of the interface or its
expected IP address. In either case, you’ll also need to know the name given to
the Calico node running on the host that owns the interface; in most cases this
will be the same as the hostname of the host.</p>

<p>For example, to secure the interface named <code class="highlighter-rouge">eth0</code> with IP 10.0.0.1 on
host <code class="highlighter-rouge">my-host</code>, run the command below.  The name of the endpoint is an
arbitrary name required for endpoint identification.</p>

<p>When running this command, replace the placeholders in angle brackets with
appropriate values for your deployment.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | calicoctl create -f -
- apiVersion: projectcalico.org/v3
  kind: HostEndpoint
  metadata:
    name: &lt;name of endpoint&gt;
    labels:
      role: webserver
      environment: production
  spec:
    interfaceName: eth0
    node: &lt;node name or hostname&gt;
    profiles: [&lt;list of profile IDs&gt;]
    expectedIPs: ["10.0.0.1"]
EOF
</code></pre></div></div>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: Felix tries to detect the correct hostname for a system. It logs
out the value it has determined at start-of-day in the following
format:</p>

  <p><code class="highlighter-rouge">2015-10-20 17:42:09,813 \[INFO\]\[30149/5\] calico.felix.config 285: Parameter FelixHostname (Felix compute host hostname) has value 'my-hostname' read from None</code></p>

  <p>The value (in this case <code class="highlighter-rouge">'my-hostname'</code>) needs to match the hostname
used in etcd. Ideally, the host’s system hostname should be set
correctly but if that’s not possible, the Felix value can be
overridden with the FelixHostname configuration setting. See
configuration for more details.</p>
</blockquote>

<p>Where <code class="highlighter-rouge">&lt;list of profile IDs&gt;</code> is an optional list of security profiles
to apply to the endpoint and labels contains a set of arbitrary
key/value pairs that can be used in selector expressions.</p>

<!-- TODO(smc) data-model: Link to new data model docs. -->

<blockquote class="alert alert-danger">
  <p><strong>Important</strong>: When rendering security rules on other hosts, Calico uses the
<code class="highlighter-rouge">expectedIPs</code> field to resolve label selectors
to IP addresses. If the <code class="highlighter-rouge">expectedIPs</code> field is omitted
then security rules that use labels will fail to match
this endpoint.</p>
</blockquote>

<p>Or, if you knew that the IP address should be 10.0.0.1, but not the name
of the interface:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | calicoctl create -f -
- apiVersion: projectcalico.org/v3
  kind: HostEndpoint
  metadata:
    name: &lt;name of endpoint&gt;
    labels:
      role: webserver
      environment: production
  spec:
    node: &lt;node name or hostname&gt;
    profiles: [&lt;list of profile IDs&gt;]
    expectedIPs: ["10.0.0.1"]
EOF
</code></pre></div></div>

<p>After you create host endpoint objects, Felix will start policing
traffic to/from that interface. If you have no policy or profiles in
place, then you should see traffic being dropped on the interface.</p>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: By default, Calico has a failsafe in place that whitelists certain
traffic such as ssh. See below for more details on
disabling/configuring the failsafe rules.</p>
</blockquote>

<p>If you don’t see traffic being dropped, check the hostname, IP address
and (if used) the interface name in the configuration. If there was
something wrong with the endpoint data, Felix will log a validation
error at <code class="highlighter-rouge">WARNING</code> level and it will ignore the endpoint:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ grep "Validation failed" /var/log/calico/felix.log
2016-05-31 12:16:21,651 [WARNING][8657/3] calico.felix.fetcd 1017:
    Validation failed for host endpoint HostEndpointId&lt;eth0&gt;, treating as
    missing: 'name' or 'expected_ipvX_addrs' must be present.;
    '{ "labels": {"foo": "bar"}, "profile_ids": ["prof1"]}'
</code></pre></div></div>

<p>The error can be quite long but it should log the precise cause of the
rejection; in this case “‘name’ or ‘expected_ipvX_addrs’ must be
present” tells us that either the interface’s name or its expected IP
address must be specified.</p>

<h2 id="creating-more-security-policy">Creating more security policy</h2>

<p>We recommend using selector-based security policy with
bare-metal workloads. This allows ordered policy to be applied to
endpoints that match particular label selectors.</p>

<p>For example, you could add a second policy for webserver access:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt; EOF | dist/calicoctl create -f -
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: webserver
  spec:
    selector: "role==\"webserver\""
    order: 100
    ingress:
    - action: Allow
      protocol: TCP
      destination:
        ports: [80]
    egress:
    - action: Allow
EOF
</code></pre></div></div>

<h2 id="failsafe-rules">Failsafe rules</h2>

<p>To avoid completely cutting off a host via incorrect or malformed
policy, Calico has a failsafe mechanism that keeps various pinholes open
in the firewall.</p>

<p>By default, Calico keeps the following ports open on <em>all</em> host endpoints:</p>

<table>
  <thead>
    <tr>
      <th>Port</th>
      <th>Protocol</th>
      <th>Direction</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td>TCP</td>
      <td>Inbound</td>
      <td>SSH access</td>
    </tr>
    <tr>
      <td>53</td>
      <td>UDP</td>
      <td>Outbound</td>
      <td>DNS queries</td>
    </tr>
    <tr>
      <td>67</td>
      <td>UDP</td>
      <td>Outbound</td>
      <td>DHCP access</td>
    </tr>
    <tr>
      <td>68</td>
      <td>UDP</td>
      <td>Inbound</td>
      <td>DHCP access</td>
    </tr>
    <tr>
      <td>179</td>
      <td>TCP</td>
      <td>Inbound &amp; Outbound</td>
      <td>BGP access (Calico networking)</td>
    </tr>
    <tr>
      <td>2379</td>
      <td>TCP</td>
      <td>Inbound &amp; Outbound</td>
      <td>etcd access</td>
    </tr>
    <tr>
      <td>2380</td>
      <td>TCP</td>
      <td>Inbound &amp; Outbound</td>
      <td>etcd access</td>
    </tr>
    <tr>
      <td>6666</td>
      <td>TCP</td>
      <td>Inbound &amp; Outbound</td>
      <td>etcd self-hosted service access</td>
    </tr>
    <tr>
      <td>6667</td>
      <td>TCP</td>
      <td>Inbound &amp; Outbound</td>
      <td>etcd self-hosted service access</td>
    </tr>
  </tbody>
</table>

<p>The lists of failsafe ports can be configured via the configuration parameters
<code class="highlighter-rouge">FailsafeInboundHostPorts</code> and <code class="highlighter-rouge">FailsafeOutboundHostPorts</code>
described in <a href="/v3.0/reference/felix/configuration">Configuring
Felix</a>.  They
can be disabled by setting each configuration value to “none”.</p>

<blockquote class="alert alert-danger">
  <p><strong>Important</strong>: Removing the inbound failsafe rules can leave a host inaccessible.</p>

  <p>Removing the outbound failsafe rules can leave Felix unable to connect
to etcd.</p>

  <p>Before disabling the failsafe rules, we recommend creating a policy to
replace it with more-specific rules for your environment: see 
<a href="#creating-basic-connectivity-and-policy">above</a>.</p>
</blockquote>

<h2 id="untracked-policy">Untracked policy</h2>

<p>Policy for host endpoints can be marked as <code class="highlighter-rouge">doNotTrack</code>.  This means that rules
in that policy should be applied before any data plane connection tracking, and
that packets allowed by these rules should not be tracked.</p>

<p>Untracked policy is designed for allowing untracked connections to a server
process running directly on a host—where, by ‘directly’, we mean <em>not</em> in a
pod/VM/container workload.  A typical scenario for using <code class="highlighter-rouge">doNotTrack</code> policy
would be a server, running directly on a host, that accepts a very high rate of
shortlived connections, such as <code class="highlighter-rouge">memcached</code>.  On Linux, if those connections
are tracked, the conntrack table can fill up and then Linux may drop packets
for further connection attempts, meaning that those newer connections will
fail.  If you are using Calico to secure that server’s host, you can avoid this
problem by defining a policy that allows access to the server’s ports and is
marked as <code class="highlighter-rouge">doNotTrack</code>.</p>

<p>Since there is no connection tracking for a <code class="highlighter-rouge">doNotTrack</code> policy, it is
important that the policy’s ingress and egress rules are specified
symmetrically.  For example, for a server on port 999, the policy must include
an ingress rule allowing access <em>to</em> port 999 and an egress rule allowing
outbound traffic <em>from</em> port 999.  (Whereas for a connection tracked policy, it
is usually enough to specify the ingress rule only, and then connection
tracking will automatically allow the return path.)</p>

<p>Because of how untracked policy is implemented, untracked ingress rules apply
to all incoming traffic through a host endpoint—regardless of where that
traffic is going—but untracked egress rules only apply to traffic that is
sent from the host itself (not from a local workload) out of that host
endpoint.</p>

<h2 id="pre-dnat-policy">Pre-DNAT policy</h2>

<p>Policy for host endpoints can be marked as <code class="highlighter-rouge">preDNAT</code>.  This means that rules in
that policy should be applied before any DNAT (Destination Network Address
Translation), which is useful if it is more convenient to specify Calico policy
in terms of a packet’s original destination IP address and port, than in terms
of that packet’s destination IP address and port after it has been DNAT’d.</p>

<p>An example is securing access to Kubernetes NodePorts from outside the cluster.
Traffic from outside is addressed to any node’s IP address, on a known
NodePort, and Kubernetes (kube-proxy) then DNATs that to the IP address of one
of the pods that provides the corresponding service, and the relevant port
number on that pod (which is usually different from the NodePort).</p>

<p>As NodePorts are the externally advertised way of connecting to services (and a
NodePort uniquely identifies a service, whereas an internal port number may
not), it makes sense to express Calico policy to expose or secure particular
Services in terms of the corresponding NodePorts.  But that is only possible if
the Calico policy is applied before DNAT changes the NodePort to something
else. Hence this kind of policy needs <code class="highlighter-rouge">preDNAT</code> set to <code class="highlighter-rouge">true</code>.</p>

<p>In addition to being applied before any DNAT, the enforcement of pre-DNAT
policy differs from that of normal host endpoint policy in three key details,
reflecting that it is designed for the policing of incoming traffic from
outside the cluster:</p>

<ul>
  <li>
    <p>Pre-DNAT policy may only have ingress rules, not egress.  (When incoming
traffic is allowed by the ingress rules, standard connection tracking is
sufficient to allow the return path traffic.)</p>
  </li>
  <li>
    <p>Pre-DNAT policy is enforced for all traffic arriving through a host
endpoint, regardless of where that traffic is going, and - in particular -
even if that traffic is routed to a local workload on the same host.
(Whereas normal host endpoint policy is skipped, for traffic going to a
local workload.)</p>
  </li>
  <li>
    <p>There is no ‘default drop’ semantic for pre-DNAT policy (as there is for
normal host endpoint policy).  In other words, if a host endpoint is defined
but has no pre-DNAT policies that explicitly allow or deny a particular
incoming packet, that packet is allowed to continue on its way, and will
then be accepted or dropped according to workload policy (if it is going to
a local workload) or to normal host endpoint policy (if not).</p>
  </li>
</ul>

<h2 id="policy-on-forwarded-traffic">Policy on forwarded traffic</h2>
<p>If <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">false</code>, the host endpoint policy applies to traffic to/from
 local processes only.</p>

<p>If <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">true</code>, the host endpoint policy applies to forwarded traffic:</p>
<ul>
  <li>Incoming traffic from a host endpoint to a local workload (container/pod/VM).</li>
  <li>Outgoing traffic from a local workload to a host endpoint.</li>
  <li>Traffic from one host endpoint that is forwarded to another host endpoint.</li>
</ul>

<p>By default, <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">false</code>.</p>

<p>Untracked policies and pre-DNAT policies must have <code class="highlighter-rouge">applyOnForward</code> set to <code class="highlighter-rouge">true</code>
because they apply to all forwarded traffic.</p>

<p>Forwarded traffic is allowed by default. In other words, if a host endpoint is
configured, but there are no rules that explicitly allow or deny a particular
forwarding flow (in any of policies with <code class="highlighter-rouge">applyOnForward</code> set to <code class="highlighter-rouge">true</code> that apply
to that host endpoint), that flow is still allowed. This is different from how Calico
treats traffic to or from a local process: traffic to or from a local process is
denied by default, if a host endpoint is configured but there is no applicable
policy that explicitly allows that traffic.</p>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: Calico’s handling of host endpoint policy has changed, since before
Calico v2.7.0, in two ways:</p>
  <ul>
    <li>It will not apply at all to forwarded traffic, by default. If you have an existing
policy and you want it to apply to forwarded traffic, you need to add <code class="highlighter-rouge">applyOnForward: true</code> to the policy.</li>
    <li>Even with <code class="highlighter-rouge">applyOnForward: true</code>, the treatment is not quite the same in
Calico v2.7.0 as in previous releases, because–once a host endpoint is configured–
Calico v2.7.0 allows forwarded traffic through that endpoint by default, whereas
previous releases denied forwarded traffic through that endpoint by default.
If you want to maintain the default-deny behavior for all host-endpoint forwarded
traffic, you can create an empty policy with <code class="highlighter-rouge">applyOnForward</code> set to <code class="highlighter-rouge">true</code>
that applies to all traffic on all host endpoints.</li>
  </ul>
</blockquote>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calicoctl apply -f - &lt;&lt;EOF
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: empty-default-deny
  spec:
    types: 
      - Ingress
      - Egress
    selector: has(host-endpoint)
    applyOnForward: true
EOF
</code></pre></div></div>
<blockquote class="alert alert-info">
  <p><strong>Note</strong>: This policy has no <code class="highlighter-rouge">order</code> field specified which causes it to default
to the highest value. Because higher order values have the lowest order of precedence,
Calico will apply this policy after all other policies. Refer to the 
<a href="/v3.0/reference/calicoctl/resources/networkpolicy#spec">policy spec</a> for
more discussion.</p>
</blockquote>

<h2 id="when-do-host-endpoint-policies-apply">When do host endpoint policies apply?</h2>

<p>As stated above, normal host endpoint policies apply to traffic that arrives on
and/or is sent to a host interface, but the rules for applying untracked and
pre-DNAT policies differ in some cases. Here we present and summarize all of
those rules together, for all possible flows and all types of host endpoints 
policy.</p>

<p>For packets that arrive on a host interface and are destined for a local
workload, i.e., a locally-hosted pod, container or VM:</p>

<ul>
  <li>
    <p>Pre-DNAT policies apply.</p>
  </li>
  <li>
    <p>Normal policies do apply if <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">true</code>. 
Normal policies do not apply if <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">false</code>.</p>
  </li>
  <li>
    <p>Untracked policies technically do apply, but never have any net positive
effect for such flows.</p>

    <blockquote class="alert alert-info">
      <p><strong>Note</strong>: To be precise, untracked policy for the incoming host interface may
apply in the forwards direction, and if so it will have the effect of forwarding
the packet to the workload without any connection tracking. But then, in
the reverse direction, there will be no conntrack state for the return
packets to match, and there is no application of any egress rules that may
be defined by the untracked policy—so unless the workload’s policy
specifically allows the relevant source IP, the return packet will be
dropped. That is the same overall result as if there was no untracked
policy at all, so in practice it is as if untracked policies do not apply
to this flow.</p>
    </blockquote>
  </li>
</ul>

<p>For packets that arrive on a host interface and are destined for a local
server process in the host namespace:</p>

<ul>
  <li>
    <p>Untracked, pre-DNAT and normal policies all apply.</p>
  </li>
  <li>
    <p>If a packet is explicitly allowed by untracked policy, it skips over any
pre-DNAT and normal policy.</p>
  </li>
  <li>
    <p>If a packet is explicitly allowed by pre-DNAT policy, it skips over any
normal policy.</p>
  </li>
</ul>

<p>For packets that arrive on a host interface (A) and are forwarded out of the
same or another host interface (B):</p>

<ul>
  <li>
    <p>Untracked policies apply, for both host interfaces A and B, but only the
ingress rules that are defined in those policies.  The forwards direction is
governed by the ingress rules of untracked policies that apply to interface
A, and the reverse direction is governed by the ingress rules of untracked
policies that apply to interface B, so those rules should be defined
symmetrically.</p>
  </li>
  <li>
    <p>Pre-DNAT policies apply, specifically the ingress rules of the pre-DNAT
policies that apply to interface A.  (The reverse direction is allowed by
conntrack state.)</p>
  </li>
  <li>
    <p>Normal policies apply if <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">true</code>: specifically, the ingress
rules of the normal policies that apply to interface A, and the egress rules of
the normal policies that apply to interface B. (The reverse direction is
allowed by conntrack state.) Normal policies do not apply if <code class="highlighter-rouge">applyOnForward</code>
is <code class="highlighter-rouge">false</code>.</p>
  </li>
  <li>
    <p>If a packet is explicitly allowed by untracked policy, it skips over any
pre-DNAT and normal policy.</p>
  </li>
  <li>
    <p>If a packet is explicitly allowed by pre-DNAT policy, it skips over any
normal policy.</p>
  </li>
</ul>

<p>For packets that are sent from a local server process (in the host namespace)
out of a host interface:</p>

<ul>
  <li>
    <p>Untracked policies apply, specifically the egress rules of the untracked
policies that apply to the host interface.</p>
  </li>
  <li>
    <p>Normal policies apply, specifically the egress rules of the normal policies
that apply to that host interface.</p>
  </li>
  <li>
    <p>Pre-DNAT policies do not apply.</p>
  </li>
</ul>

<p>For packets that are sent from a local workload out of a host interface:</p>

<ul>
  <li>
    <p>No untracked or pre-DNAT host endpoint policies apply.</p>
  </li>
  <li>
    <p>Normal policies apply if <code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">true</code>: specifically, the egress 
rules of the normal policies that apply to the outgoing interface. (The reverse
direction is allowed by conntrack state.) Normal policies do not apply if 
<code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">false</code>.</p>
  </li>
</ul>

<h2 id="host-endpoint-policy-a-worked-example">Host endpoint policy: a worked example</h2>

<p>Imagine that the administrator of a Kubernetes cluster wants to secure it as much as
possible against incoming traffic from outside the cluster.  But suppose that
the cluster provides various useful services that are exposed as Kubernetes
NodePorts, i.e., as well-known TCP port numbers that appear to be available on
any node in the cluster. The administrator does want to expose some
of those NodePorts to traffic from outside.</p>

<p>In this example we will use pre-DNAT policy applied to the external interfaces
of each cluster node:</p>

<ul>
  <li>
    <p>to disallow incoming traffic from outside, in general</p>
  </li>
  <li>
    <p>but then to allow incoming traffic to particular NodePorts.</p>
  </li>
</ul>

<p>We use pre-DNAT policy for these purposes, instead of normal host endpoint
policy, because:</p>

<ol>
  <li>
    <p>We want the protection against general external traffic to apply regardless
of where that traffic is destined for - for example, to a locally hosted
pod, or to a pod on another node, or to a local server process running on
the host itself.  Pre-DNAT policy is enforced in all of those cases - as we
want - whereas normal host endpoint policy is not enforced for traffic going
to a local pod.</p>
  </li>
  <li>
    <p>We want to write this policy in terms of the advertised NodePorts, not in
terms of whatever internal port numbers those may be transformed to.
kube-proxy on the ingress node will use a DNAT to change a NodePort number
and IP address to those of one of the pods that backs the relevant Service.
Our policy therefore needs to take effect <em>before</em> that DNAT - and that
means that it must be a pre-DNAT policy.</p>
  </li>
</ol>

<p>Here is the pre-DNAT policy that we need to disallow incoming external traffic
in general:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calicoctl apply -f - &lt;&lt;EOF
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: allow-cluster-internal-ingress
  spec:
    order: 10
    preDNAT: true
    applyOnForward: true
    ingress:
      - action: Allow
        source:
          nets: [10.240.0.0/16, 192.168.0.0/16]
    selector: has(host-endpoint)
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: drop-other-ingress
  spec:
    order: 20
    preDNAT: true
    applyOnForward: true
    ingress:
      - action: Deny
    selector: has(host-endpoint)
EOF
</code></pre></div></div>

<p>Specifically, this policy allows traffic coming from IP addresses that are
known to be cluster-internal, and denies traffic from any other sources.  For
the cluster-internal IP addresses in this example, we assume 10.240.0.0/16 for
the nodes’ own IP addresses, and 192.168.0.0/16 for IP addresses that
Kubernetes will assign to pods; obviously you should adjust for the CIDRs that
are in use in your own cluster.</p>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: The <code class="highlighter-rouge">drop-other-ingress</code> policy has a higher <code class="highlighter-rouge">order</code> value than
<code class="highlighter-rouge">allow-cluster-internal-ingress</code>, so that it applies <em>after</em>
<code class="highlighter-rouge">allow-cluster-internal-ingress</code>.</p>

  <p>The explicit <code class="highlighter-rouge">drop-other-ingress</code> policy is needed because there is no
automatic default-drop semantic for pre-DNAT policy. There <em>is</em> a
default-drop semantic for normal host endpoint policy but—as noted above—normal 
host endpoint policy is not always enforced.</p>
</blockquote>

<p>We also need policy to allow <em>egress</em> traffic through each node’s external
interface.  Otherwise, when we define host endpoints for those interfaces, no
egress traffic will be allowed from local processes (except for traffic that is
allowed by the <a href="#failsafe-rules">failsafe rules</a>). Because there is no default-deny
rule for forwarded traffic, forwarded traffic will be allowed for host endpoints.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calicoctl apply -f - &lt;&lt;EOF
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: allow-outbound-external
  spec:
    order: 10
    egress:
      - action: Allow
    selector: has(host-endpoint)
EOF
</code></pre></div></div>

<blockquote class="alert alert-info">
  <p><strong>Note</strong>: These egress rules are defined as normal host endpoint policies, not
pre-DNAT, because pre-DNAT policy does not support egress rules. (Which is
because pre-DNAT policies are enforced at a point in the Linux networking
stack where it is not yet determined what a packet’s outgoing interface will
be.)</p>

  <p>Because these are normal host endpoint policies which do not
apply to forwarded traffic (<code class="highlighter-rouge">applyOnForward</code> is <code class="highlighter-rouge">false</code>), they
are not enforced for traffic that is sent from a local pod.</p>

  <p>The policy above allows applications or server processes running on the nodes
themselves (as opposed to in pods) to connect outbound to any destination.
In case you have a use case for restricting to particular IP addresses, you
can achieve that by adding a corresponding <code class="highlighter-rouge">destination</code> spec.</p>
</blockquote>

<p>Now we can define a host endpoint for the outwards-facing interface of each
node.  The policies above all have a selector that makes them applicable to any
endpoint with a <code class="highlighter-rouge">host-endpoint</code> label, so we should include that label in our
definitions.  For example, for <code class="highlighter-rouge">eth0</code> on <code class="highlighter-rouge">node1</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calicoctl apply -f - &lt;&lt;EOF
- apiVersion: projectcalico.org/v3
  kind: HostEndpoint
  metadata:
    name: node1-eth0
    labels:
      host-endpoint: ingress
  spec:
    interfaceName: eth0
    node: node1
EOF
</code></pre></div></div>

<p>After defining host endpoints for each node, you should find that internal
cluster communications are all still working as normal—for example, that you
can successfully execute commands like <code class="highlighter-rouge">calicoctl get hep</code> and <code class="highlighter-rouge">calicoctl get
pol</code>—but that it is impossible to connect into the cluster from outside
(except for any <a href="#failsafe-rules">failsafe ports</a>).  For example, if the
cluster includes a Kubernetes Service that is exposed as NodePort 31852, you
should find, at this point, that that NodePort works from within the cluster,
but not from outside.</p>

<p>To open a pinhole for that NodePort, for external access, you can configure a
pre-DNAT policy like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>calicoctl apply -f - &lt;&lt;EOF
- apiVersion: projectcalico.org/v3
  kind: GlobalNetworkPolicy
  metadata:
    name: allow-nodeport
  spec:
    preDNAT: true
    applyOnForward: true
    order: 10
    ingress:
      - action: Allow
        protocol: TCP
        destination:
          ports: [31852]
    selector: has(host-endpoint)
EOF
</code></pre></div></div>

<p>If you wanted to make that NodePort accessible only through particular nodes, you could achieve that by giving those nodes a particular <code class="highlighter-rouge">host-endpoint</code> label:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      host-endpoint: &lt;special-value&gt;
</code></pre></div></div>

<p>and then using <code class="highlighter-rouge">host-endpoint=='&lt;special-value&gt;'</code> as the selector of the
<code class="highlighter-rouge">allow-nodeport</code> policy, instead of <code class="highlighter-rouge">has(host-endpoint)</code>.</p>

<h3 id="a-note-about-conntrack">A note about conntrack</h3>

<p>Calico uses Linux’s connection tracking (‘conntrack’) as an important
optimization to its processing.  It generally means that Calico only needs to
check its policies for the first packet in an allowed flow—between a pair of
IP addresses and ports—and then conntrack automatically allows further
packets in the same flow, without Calico rechecking every packet.</p>

<p>This can, however, make it look like a Calico policy is not working as it
should, if policy is changed to disallow a flow that was previously allowed.
If packets were recently exchanged on the previously allowed flow, and so there
is conntrack state for that flow that has not yet expired, that conntrack state
will allow further packets between the same IP addresses and ports, even after
the Calico policy has been changed.</p>

<p>Per Calico’s current implementation, there are two workarounds for this:</p>

<ul>
  <li>
    <p>Somehow ensure that no further packets flow between the relevant IP
 addresses and ports until the conntrack state has expired (typically about
 a minute).</p>
  </li>
  <li>
    <p>Use the ‘conntrack’ tool to delete the relevant conntrack state; for example
 <code class="highlighter-rouge">conntrack -D -p tcp --orig-port-dst 80</code>.</p>
  </li>
</ul>

<p>Then you should observe that the new Calico policy is enforced for new packets.</p>

              
              <!-- BOTTOM DOCUMENTATION PAGE NAVBAR -->
              <div style="margin-top: 60px; margin-bottom: 40px; padding-top: 20px; border-top: 1px solid #999; text-align: left; color: #999;">Rate this Page: <div class="rw-ui-container" style="margin-top: -5px;"></div> <a href="https://www.projectcalico.org/contact?type=docs&file=v3.0/getting-started/bare-metal/bare-metal.md" style="margin-left: 30px; color: #999; text-decoration: none;" target="_blank"><i class="fa fa-envelope" aria-hidden="true"></i> Provide Feedback</a> <a href="https://www.projectcalico.org/community#slack" style="margin-left: 30px; color: #999; text-decoration: none;" target="_blank"><i class="fa fa-slack" aria-hidden="true"></i> Get Help via Slack</a> <a href="https://www.projectcalico.org/mvp" style="margin-left: 30px; color: #999; text-decoration: none;" target="_blank"><i class="fa fa-trophy" aria-hidden="true"></i> Ask our MVPs</a> <a href="https:/tigera.io/training" style="margin-left: 30px; color: #999; text-decoration: none;" target="_blank"><i class="fa fa-graduation-cap" aria-hidden="true"></i> Training</a></div>
              <!-- END BOTTOM DOCUMENTATION PAGE NAVBAR -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Start Visual Website Optimizer Asynchronous Code -->
    <script type='text/javascript'>
      var _vwo_code=(function(){
      var account_id=287573,
      settings_tolerance=2000,
      library_tolerance=2500,
      use_existing_jquery=false,
      /* DO NOT EDIT BELOW THIS LINE */
      f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
    </script>
    <!-- End Visual Website Optimizer Asynchronous Code -->
    <!-- DOCUMENTATION RATING ANALYTICS -->
   <script type="text/javascript">(function(d, t, e, m){
    // Async Rating-Widget initialization.
    window.RW_Async_Init = function(){
        RW.init({
            huid: "368439",
            uid: "33da22c0dff384767b5074aaf10ebc50",
            source: "website",
            options: {
                "advanced": {
					"font": {
						"color": "#999999"
					},
                    "layout": {
                        "align": {
                            "hor": "left"
                        }
                    },
                    "text": {
                        "rateThis": "Rate this"
                    }
                },
				"label": {
					"background": "#FFFFFF"
				},
				"reVote": true,
				"showInfo": false,
				/*"showTooltip": false,*/
				"hideRecommendations": false,
				"showReport": false,
				"showLoader": false,
                "style": "oxygen",
                "isDummy": false
            } 
        });
        RW.render();
    };
        // Append Rating-Widget JavaScript library.
    var rw, s = d.getElementsByTagName(e)[0], id = "rw-js",
        l = d.location, ck = "Y" + t.getFullYear() + 
        "M" + t.getMonth() + "D" + t.getDate(), p = l.protocol,
        f = ((l.search.indexOf("DBG=") > -1) ? "" : ".min"),
        a = ("https:" == p ? "secure." + m + "js/" : "js." + m);
    if (d.getElementById(id)) return;              
    rw = d.createElement(e);
    rw.id = id; rw.async = true; rw.type = "text/javascript";
    rw.src = p + "//" + a + "external" + f + ".js?ck=" + ck;
    s.parentNode.insertBefore(rw, s);
    }(document, new Date(), "script", "rating-widget.com/"));</script>
    <!-- END DOCUMENTATION RATING ANALYTICS -->
  </body>
</html>
